#!/usr/bin/make -f
#export DH_VERBOSE=1
# This is the debhelper compatability version to use.

MY_MAKEFLAGS=
ifneq (,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
  NUMJOBS=$(patsubst parallel=%,%,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
  MY_MAKEFLAGS=-j$(NUMJOBS)
endif

#export DH_COMPAT=3
APPNAME := radeon-profile-daemon
DESTDIR := $(CURDIR)/debian/$(APPNAME)

build: build-stamp
build-stamp:

	# Build process
	cd $(APPNAME)
	qmake -qt=opt-qt59 PREFIX=/usr ./$(APPNAME)/$(APPNAME).pro
	make $(MY_MAKEFLAGS)
	# End of build process

	touch build-stamp

clean:
		dh_testdir
		dh_testroot
		rm -f build-stamp
		# Add here commands to clean up after the build process.
		dh_clean

install: build
		dh_testdir
		dh_testroot
		dh_prep
		dh_installdirs
		install -pdm755 $(DESTDIR)/usr/bin
		###  Upstart directories
		install -pdm755 $(DESTDIR)/etc/init
		install -pdm755 $(DESTDIR)/usr/share
		###  Copy radeon-profile-daemon
		install -Dm755 $(CURDIR)/target/$(APPNAME) $(DESTDIR)/usr/bin/
		###  Upstart start scrypt
		#install -Dm664  $(CURDIR)/extra/radeon-profile-daemon.conf $(DESTDIR)/etc/init
		echo 'description "radeon-profile-daemon Upstart"' > $(DESTDIR)/etc/init/radeon-profile-daemon.conf
		echo 'author "gogo"' >> $(DESTDIR)/etc/init/radeon-profile-daemon.conf
		echo '' >> $(DESTDIR)/etc/init/radeon-profile-daemon.conf
		echo '# start on startup' >> $(DESTDIR)/etc/init/radeon-profile-daemon.conf
		echo 'start on runlevel [2345]' >> $(DESTDIR)/etc/init/radeon-profile-daemon.conf
		echo 'stop on shutdown|reboot' >> $(DESTDIR)/etc/init/radeon-profile-daemon.conf
		echo '' >> $(DESTDIR)/etc/init/radeon-profile-daemon.conf
		echo 'exec radeon-profile-daemon' >> $(DESTDIR)/etc/init/radeon-profile-daemon.conf
		echo '' >> $(DESTDIR)/etc/init/radeon-profile-daemon.conf
		echo 'respawn' >> $(DESTDIR)/etc/init/radeon-profile-daemon.conf					

# Build architecture-independent files here.
binary-indep: build install
# We have nothing to do by default.

# Build architecture-dependent files here.
binary-arch: build install
		dh_testdir
		dh_testroot
		dh_installdocs
		dh_installexamples
		dh_installman
		dh_link
		#dh_strip --dbg-package=my-application-dbg
		dh_compress
		dh_fixperms
		dh_installdeb
		dh_shlibdeps
		dh_gencontrol
		dh_md5sums
		dh_builddeb

binary: binary-indep binary-arch
.PHONY: build clean binary-indep binary-arch binary install configure
